# This workflow will deploy the PetClinic application to Azure Container Apps
name: PetClinic Deploy

on:
  # When you directly push in the main branch
  push:   
    branches: 
      - pipeline
    paths:
      - 'scenarios/aca-internal/bicep/sample-apps/cloud-foundry-spring-boot-application/src/**'
      - '!scenarios/aca-internal/bicep/sample-apps/cloud-foundry-spring-boot-application/src/**.md'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: true

defaults:
  run:
    working-directory: scenarios/aca-internal/bicep/sample-apps/cloud-foundry-spring-boot-application

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login via Azure CLI
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build Jar with Maven
        run: mvn clean package
        working-directory: src

      - name: Prepare env variables
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            export RESOURCENAME_RESOURCEGROUP_SPOKE=$(az deployment sub show -n acalza01-spokenetwork --query properties.outputs.spokeResourceGroupName.value -o tsv)
            export ENVIRONMENT_NAME=$(az deployment group show -n acalza01-appplat -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.containerAppsEnvironmentName.value -o tsv)
            export RESOURCEID_IDENTITY_ACR=$(az deployment group show -n acalza01-dependencies -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.containerRegistryUserAssignedIdentityId.value -o tsv)
            export REGISTRYNAME_ACR=$(az deployment group show -n acalza01-dependencies -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.containerRegistryName.value -o tsv)
            export LOGINSERVER_ACR=$(az deployment group show -n acalza01-dependencies -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.containerRegistryLoginServer.value -o tsv)
            export RESOURCENAME_AGENTPOOL=$(az deployment group show -n acalza01-dependencies -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.containerRegistryAgentPoolName.value -o tsv)
            export RESOURCEID_EUREKA=$(az deployment group show -n acalza01-appplat-java -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.eurekaId.value -o tsv)    
            export RESOURCEID_CONFIGSERVER=$(az deployment group show -n acalza01-appplat-java -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.configServerId.value -o tsv)
            export RESOURCEID_MYSQL_DATABASE=$(az deployment group show -n acalza01-appplat-java -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.databaseId.value -o tsv)
            export RESOURCEID_MYSQL_USERASSIGNEDIDENTITY_CLIENTID=$(az deployment group show -n acalza01-appplat-java -g $RESOURCENAME_RESOURCEGROUP_SPOKE --query properties.outputs.userAssignedIdentityClientId.value -o tsv)
            echo RESOURCENAME_RESOURCEGROUP_SPOKE: $RESOURCENAME_RESOURCEGROUP_SPOKE && \
            echo ENVIRONMENT_NAME: $ENVIRONMENT_NAME && \
            echo RESOURCEID_IDENTITY_ACR: $RESOURCEID_IDENTITY_ACR && \
            echo REGISTRYNAME_ACR: $REGISTRYNAME_ACR && \
            echo LOGINSERVER_ACR: $LOGINSERVER_ACR && \
            echo RESOURCENAME_AGENTPOOL: $RESOURCENAME_AGENTPOOL && \
            echo RESOURCEID_MYSQL_DATABASE: $RESOURCEID_MYSQL_DATABASE && \
            echo RESOURCEID_MYSQL_USERASSIGNEDIDENTITY_CLIENTID: $RESOURCEID_MYSQL_USERASSIGNEDIDENTITY_CLIENTID && \
            echo RESOURCEID_EUREKA: $RESOURCEID_EUREKA && \
            echo RESOURCEID_CONFIGSERVER: $RESOURCEID_CONFIGSERVER

      - name: Prepare image version variable
        run: export IMAGE_TAG=ga-${{ github.run_number }}-$(date +%Y%m%d%H%M%S)

      - name: Queue Build for application vets-service
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az acr build -t spring-petclinic-vets-service:${{ IMAGE_TAG }} \
              -r ${{ REGISTRYNAME_ACR }} src/spring-petclinic-vets-service/target/docker \
              --build-arg ARTIFACT_NAME=vets-service-3.0.1 \
              --build-arg  EXPOSED_PORT=8080 \
              --agent-pool ${{ RESOURCENAME_AGENTPOOL }}

      - name: Queue Build for application visits-service
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az acr build -t spring-petclinic-visits-service:${{ IMAGE_TAG }} \
              -r ${{ REGISTRYNAME_ACR }} src/spring-petclinic-visits-service/target/docker \
              --build-arg ARTIFACT_NAME=visits-service-3.0.1 \
              --build-arg  EXPOSED_PORT=8080 \
              --agent-pool ${{ RESOURCENAME_AGENTPOOL }}

      - name: Queue Build for application customers-service
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az acr build -t spring-petclinic-customers-service:${{ IMAGE_TAG }} \
              -r ${{ REGISTRYNAME_ACR }} src/spring-petclinic-customers-service/target/docker \
              --build-arg ARTIFACT_NAME=customers-service-3.0.1 \
              --build-arg  EXPOSED_PORT=8080 \
              --agent-pool ${{ RESOURCENAME_AGENTPOOL }}

       - name: Queue Build for application api-gateway
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az acr build -t spring-petclinic-api-gateway:${{ IMAGE_TAG }} \
              -r ${{ REGISTRYNAME_ACR }} src/spring-petclinic-api-gateway/target/docker \
              --build-arg ARTIFACT_NAME=api-gateway-3.0.1 \
              --build-arg  EXPOSED_PORT=8080 \
              --agent-pool ${{ RESOURCENAME_AGENTPOOL }}

      - name: Deploy image to Azure Container Apps
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        resourceGroupName: ${{ RESOURCENAME_RESOURCEGROUP_SPOKE }}
        template: modules/petclinic.bicep
        parameters: 'managedEnvironmentsName=${ ENVIRONMENT_NAME }} eurekaId=${{ RESOURCEID_EUREKA }} configServerId=${{ RESOURCEID_CONFIGSERVER }} mysqlDBId=${{ RESOURCEID_MYSQL_DATABASE }} mysqlUserAssignedIdentityClientId=${{ RESOURCEID_MYSQL_USERASSIGNEDIDENTITY_CLIENTID }} acrRegistry=${{ LOGINSERVER_ACR }} imageTag=${{ IMAGE_TAG }} acrIdentityId=${{ RESOURCEID_IDENTITY_ACR }}'
        failOnStdErr: false